from pprint import pprint
from common.MaltegoTransform import *
from common.linuxtaskrunner import bashrunner

__author__ = 'Marc Gurreri'
__copyright__ = 'Copyright 2018, msploitego Project'
__credits__ = []
__license__ = 'GPLv3'
__version__ = '0.1'
__maintainer__ = 'Marc Gurreri'
__email__ = 'me@me.com'
__status__ = 'Development'

def dotransform(args):
    mt = MaltegoTransform()
    # mt.debug(pprint(args))
    mt.parseArguments(args)
    ip = mt.getVar("ip")
    port = mt.getVar("port")
    hostid = mt.getVar("hostid")
    body = mt.getVar("body")
    url = mt.getValue()
    details = None
    if body:
        details = body
    else:
        bashlog = bashrunner("wget -qO-  {}".format(url))
        if bashlog:
            details = "".join(bashlog)
    if details:
        webfile = mt.addEntity("msploitego.WebFile", url)
        webfile.setValue(url)
        webfile.addAdditionalFields("details","Details",False, details)
        webfile.addAdditionalFields("url", "Site URL", False, url)
        webfile.addAdditionalFields("ip", "IP Address", False, ip)
        webfile.addAdditionalFields("port", "Port", False, port)
    mt.returnOutput()
    mt.addUIMessage("completed!")

dotransform(sys.argv)
# args = ['getwebfile.py',
#  '',
#  'maltego.v2.value.property=http://10.11.1.115:443/manual/mod/mod_usertrack.html#headers=BAhJQzolUmV4OjpQcm90bzo6SHR0cDo6UGFja2V0OjpIZWFkZXJ7ESIJRGF0ZSIiV2VkLCAxMCBKYW4gMjAxOCAwMDoxMDo1NiBHTVQiC1NlcnZlciIiQXBhY2hlLzIuMC40MCAoUmVkIEhhdCBMaW51eCkiFUNvbnRlbnQtTG9jYXRpb24iGm1vZF91c2VydHJhY2suaHRtbC5lbiIJVmFyeSIObmVnb3RpYXRlIghUQ04iC2Nob2ljZSISTGFzdC1Nb2RpZmllZCIiRnJpLCAwOSBBdWcgMjAwMiAxNzo0ODoxMiBHTVQiCUVUYWciIiI2MTljMS0zM2QyLTI3YmNmMDA7MzFmZWRjMDAiIhJBY2NlcHQtUmFuZ2VzIgpieXRlcyITQ29udGVudC1MZW5ndGgiCjEzMjY2Ig9Db25uZWN0aW9uIgpjbG9zZSIRQ29udGVudC1UeXBlIiJ0ZXh0L2h0bWw7IGNoYXJzZXQ9SVNPLTg4NTktMSIVQ29udGVudC1MYW5ndWFnZSIHZW4HOhBAZGNhc2VfaGFzaHsRIglkYXRlQAciC3NlcnZlckAJIhVjb250ZW50LWxvY2F0aW9uQAsiCXZhcnlADSIIdGNuQA8iEmxhc3QtbW9kaWZpZWRAESIJZXRhZ0ATIhJhY2NlcHQtcmFuZ2VzQBUiE2NvbnRlbnQtbGVuZ3RoQBciD2Nvbm5lY3Rpb25AGSIRY29udGVudC10eXBlQBsiFWNvbnRlbnQtbGFuZ3VhZ2VAHToQQGNtZF9zdHJpbmciFkhUVFAvMS4xIDIwMCBPSw0K#code=200#ip=10.11.1.115#body=<html><head><META http-equiv\\="Content-Type" content\\="text/html; charset\\=ISO-8859-1"><!--\n XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\n This file is generated from xml source: DO NOT EDIT\n XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\n --><title>mod_usertrack - Apache HTTP Server</title><link href\\="../style/manual.css" type\\="text/css" rel\\="stylesheet"></head><body><blockquote><div align\\="center"><img src\\="../images/sub.gif" alt\\="[APACHE DOCUMENTATION]"><h3>Apache HTTP Server Version 2.0</h3></div><h1 align\\="center">Apache Module mod_usertrack</h1><table cellspacing\\="1" cellpadding\\="0" bgcolor\\="\\#cccccc"><tr><td><table bgcolor\\="\\#ffffff"><tr><td nowrap\\="nowrap" valign\\="top"><span class\\="help">Description:\n </span></td><td>\n<em>Clickstream</em> logging of user activity on a site\n</td></tr><tr><td nowrap\\="nowrap"><a href\\="module-dict.html\\#Status" class\\="help">Status:\n </a></td><td>Extension</td></tr><tr><td nowrap\\="nowrap"><a href\\="module-dict.html\\#ModuleIdentifier" class\\="help">Module&nbsp;Identifier:\n </a></td><td>usertrack_module</td></tr></table></td></tr></table><h2>Summary</h2>\n <p>Previous releases of Apache have included a module which\n generates a \'clickstream\' log of user activity on a site using\n cookies. This was called the "cookies" module, mod_cookies. In\n Apache 1.2 and later this module has been renamed the "user\n tracking" module, mod_usertrack. This module has been\n simplified and new directives added.</p>\n<h2>Directives</h2><ul><li><a href\\="\\#cookiedomain">CookieDomain</a></li><li><a href\\="\\#cookieexpires">CookieExpires</a></li><li><a href\\="\\#cookiename">CookieName</a></li><li><a href\\="\\#cookiestyle">CookieStyle</a></li><li><a href\\="\\#cookietracking">CookieTracking</a></li></ul><h2>Logging</h2>\n <p>Previously, the cookies module (now the user tracking\n module) did its own logging, using the <code class\\="directive">CookieLog</code>\n directive. In this release, this module does no logging at all.\n Instead, a configurable log format file should be used to log\n user click-streams. This is possible because the logging module\n now allows multiple log files. The cookie itself is logged by\n using the text <code>%{cookie}n</code> in the log file format. For\n example:</p>\n<blockquote><table cellpadding\\="10"><tr><td bgcolor\\="\\#eeeeee"><code>\nCustomLog logs/clickstream "%{cookie}n %r %t"\n</code></td></tr></table></blockquote>\n <p>For backward compatibility the configurable log module\n implements the old <a href\\="../mod/mod_log_config.html\\#cookielog" class\\="directive"><code class\\="directive">CookieLog</code></a> directive, but this\n should be upgraded to the above <a href\\="../mod/mod_log_config.html\\#customlog" class\\="directive"><code class\\="directive">CustomLog</code></a> directive. </p>\n<h2>2-digit or 4-digit dates for cookies?</h2>\n <p>(the following is from message\n &lt;022701bda43d$9d32bbb0$1201a8c0@christian.office.sane.com&gt;\n in the new-httpd archives) </p>\n<pre>\nFrom: "Christian Allen" &lt;christian@sane.com&gt;\nSubject: Re: Apache Y2K bug in mod_usertrack.c\nDate: Tue, 30 Jun 1998 11:41:56 -0400\nDid some work with cookies and dug up some info that might be useful.\nTrue, Netscape claims that the correct format NOW is four digit dates, and\nfour digit dates do in fact work... for Netscape 4.x (Communicator), that\nis. However, 3.x and below do NOT accept them. It seems that Netscape\noriginally had a 2-digit standard, and then with all of the Y2K hype and\nprobably a few complaints, changed to a four digit date for Communicator.\nFortunately, 4.x also understands the 2-digit format, and so the best way to\nensure that your expiration date is legible to the client\'s browser is to\nuse 2-digit dates.\nHowever, this does not limit expiration dates to the year 2000; if you use\nan expiration year of "13", for example, it is interpreted as 2013, NOT\n1913! In fact, you can use an expiration year of up to "37", and it will be\nunderstood as "2037" by both MSIE and Netscape versions 3.x and up (not sure\nabout versions previous to those). Not sure why Netscape used that\nparticular year as its cut-off point, but my guess is that it was in respect\nto UNIX\'s 2038 problem. Netscape/MSIE 4.x seem to be able to understand\n2-digit years beyond that, at least until "50" for sure (I think they\nunderstand up until about "70", but not for sure).\nSummary: Mozilla 3.x and up understands two digit dates up until "37"\n(2037). Mozilla 4.x understands up until at least "50" (2050) in 2-digit\nform, but also understands 4-digit years, which can probably reach up until\n9999. Your best bet for sending a long-life cookie is to send it for some\ntime late in the year "37".\n</pre>\n<hr><h2><a name\\="CookieDomain">CookieDomain</a> <a name\\="cookiedomain">Directive</a></h2><table cellpadding\\="1" cellspacing\\="0" border\\="0" bgcolor\\="\\#cccccc"><tr><td><table bgcolor\\="\\#ffffff"><tr><td nowrap\\="nowrap"><strong>Description: \n </strong></td><td>The domain to which the tracking cookie applies</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Syntax" class\\="help">Syntax:\n </a></td><td>CookieDomain <em>domain</em></td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Context" class\\="help">Context:\n </a></td><td>server config, virtual host, directory, .htaccess</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Override" class\\="help">Override:\n </a></td><td>FileInfo</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Status" class\\="help">Status:\n </a></td><td>Extension</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Module" class\\="help">Module:\n </a></td><td>mod_usertrack</td></tr></table></td></tr></table>\n <p>This directive controls the setting of the domain to which\n the tracking cookie applies. If not present, no domain is\n included in the cookie header field.</p>\n <p>The domain string <strong>must</strong> begin with a dot, and\n <strong>must</strong> include at least one embedded dot. That is,\n ".foo.com" is legal, but "foo.bar.com" and ".com" are not.</p>\n<hr><h2><a name\\="CookieExpires">CookieExpires</a> <a name\\="cookieexpires">Directive</a></h2><table cellpadding\\="1" cellspacing\\="0" border\\="0" bgcolor\\="\\#cccccc"><tr><td><table bgcolor\\="\\#ffffff"><tr><td nowrap\\="nowrap"><strong>Description: \n </strong></td><td>Expiry time for the tracking cookie</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Syntax" class\\="help">Syntax:\n </a></td><td>CookieExpires <em>expiry-period</em></td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Context" class\\="help">Context:\n </a></td><td>server config, virtual host, directory, .htaccess</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Override" class\\="help">Override:\n </a></td><td>FileInfo</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Status" class\\="help">Status:\n </a></td><td>Extension</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Module" class\\="help">Module:\n </a></td><td>mod_usertrack</td></tr></table></td></tr></table>\n <p>When used, this directive sets an expiry time on the cookie\n generated by the usertrack module. The <em>expiry-period</em>\n can be given either as a number of seconds, or in the format\n such as "2 weeks 3 days 7 hours". Valid denominations are:\n years, months, weeks, hours, minutes and seconds. If the expiry\n time is in any format other than one number indicating the\n number of seconds, it must be enclosed by double quotes.</p>\n <p>If this directive is not used, cookies last only for the\n current browser session.</p>\n<hr><h2><a name\\="CookieName">CookieName</a> <a name\\="cookiename">Directive</a></h2><table cellpadding\\="1" cellspacing\\="0" border\\="0" bgcolor\\="\\#cccccc"><tr><td><table bgcolor\\="\\#ffffff"><tr><td nowrap\\="nowrap"><strong>Description: \n </strong></td><td>Name of the tracking cookie</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Syntax" class\\="help">Syntax:\n </a></td><td>CookieName <em>token</em></td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Default" class\\="help">Default: \n </a></td><td><code>CookieName Apache</code></td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Context" class\\="help">Context:\n </a></td><td>server config, virtual host, directory, .htaccess</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Override" class\\="help">Override:\n </a></td><td>FileInfo</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Status" class\\="help">Status:\n </a></td><td>Extension</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Module" class\\="help">Module:\n </a></td><td>mod_usertrack</td></tr></table></td></tr></table>\n <p>This directive allows you to change the name of the cookie\n this module uses for its tracking purposes. By default the\n cookie is named "<code>Apache</code>".</p>\n <p>You must specify a valid cookie name; results are\n unpredictable if you use a name containing unusual characters.\n Valid characters include A-Z, a-z, 0-9, "_", and "-".</p>\n<hr><h2><a name\\="CookieStyle">CookieStyle</a> <a name\\="cookiestyle">Directive</a></h2><table cellpadding\\="1" cellspacing\\="0" border\\="0" bgcolor\\="\\#cccccc"><tr><td><table bgcolor\\="\\#ffffff"><tr><td nowrap\\="nowrap"><strong>Description: \n </strong></td><td>Format of the cookie header field</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Syntax" class\\="help">Syntax:\n </a></td><td>CookieStyle\n <em>Netscape|Cookie|Cookie2|RFC2109|RFC2965</em></td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Default" class\\="help">Default: \n </a></td><td><code>CookieStyle Netscape</code></td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Context" class\\="help">Context:\n </a></td><td>server config, virtual host, directory, .htaccess</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Override" class\\="help">Override:\n </a></td><td>FileInfo</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Status" class\\="help">Status:\n </a></td><td>Extension</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Module" class\\="help">Module:\n </a></td><td>mod_usertrack</td></tr></table></td></tr></table>\n <p>This directive controls the format of the cookie header\n field. The three formats allowed are:</p>\n <ul>\n <li><strong>Netscape</strong>, which is the original but now deprecated\n syntax. This is the default, and the syntax Apache has\n historically used.</li>\n <li><strong>Cookie</strong> or <strong>RFC2109</strong>, which is the syntax that\n superseded the Netscape syntax.</li>\n <li><strong>Cookie2</strong> or <strong>RFC2965</strong>, which is the most\n current cookie syntax.</li>\n </ul>\n <p>Not all clients can understand all of these formats. but you\n should use the newest one that is generally acceptable to your\n users\' browsers.</p>\n<hr><h2><a name\\="CookieTracking">CookieTracking</a> <a name\\="cookietracking">Directive</a></h2><table cellpadding\\="1" cellspacing\\="0" border\\="0" bgcolor\\="\\#cccccc"><tr><td><table bgcolor\\="\\#ffffff"><tr><td nowrap\\="nowrap"><strong>Description: \n </strong></td><td>Enables tracking cookie</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Syntax" class\\="help">Syntax:\n </a></td><td>CookieTracking on|off</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Default" class\\="help">Default: \n </a></td><td><code>CookieTracking off</code></td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Context" class\\="help">Context:\n </a></td><td>server config, virtual host, directory, .htaccess</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Override" class\\="help">Override:\n </a></td><td>FileInfo</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Status" class\\="help">Status:\n </a></td><td>Extension</td></tr><tr><td nowrap\\="nowrap"><a href\\="directive-dict.html\\#Module" class\\="help">Module:\n </a></td><td>mod_usertrack</td></tr></table></td></tr></table>\n <p>When the user track module is compiled in, and\n "CookieTracking on" is set, Apache will start sending a\n user-tracking cookie for all new requests. This directive can\n be used to turn this behavior on or off on a per-server or\n per-directory basis. By default, compiling mod_usertrack will\n not activate cookies. </p>\n<hr></blockquote><h3 align\\="center">Apache HTTP Server Version 2.0</h3><a href\\="./"><img src\\="../images/index.gif" alt\\="Index"></a><a href\\="../"><img src\\="../images/home.gif" alt\\="Home"></a></body></html>#mtime=2002-08-09 17:48:12 UTC#vhost=10.11.1.115#path=/manual/mod/mod_usertrack.html#createdat=2018-01-09 22:03:25 UTC#websiteid=375#ctype=text/html; charset\\=ISO-8859-1#port=443#host=10.11.1.115#id=8778#updatedat=2018-01-10 00:11:35 UTC']
#
# dotransform(args)